<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa con POI Personalizzati</title>
    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        #map { width: 300px; height: 300px; position: relative; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        const API_KEY = 'e9pLQRlbmlvafLyJ6L8B'; // Sostituisci con la tua API Key di MapTiler
        let map;
        let userMarker = null;
        let firstLoad = true;
        let savedMarkers = JSON.parse(localStorage.getItem('markers')) || [];

        function onLocationFound(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            if (firstLoad) {
                map = new maplibregl.Map({
                    container: 'map',
                    style: `https://api.maptiler.com/maps/streets/style.json?key=${API_KEY}`,
                    center: [lon, lat], 
                    zoom: 15,
                    pitch: 60,
                    bearing: 0,
                    antialias: true
                });

                map.addControl(new maplibregl.NavigationControl());

                userMarker = new maplibregl.Marker({ color: 'red' })
                    .setLngLat([lon, lat])
                    .addTo(map);

                map.on('load', () => {
                    loadSavedMarkers();
                });

                firstLoad = false;
            }

            navigator.geolocation.watchPosition(updatePosition, onLocationError, { enableHighAccuracy: true });
        }

        function updatePosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            if (userMarker) {
                userMarker.setLngLat([lon, lat]);
            }
        }

        function onLocationError(error) {
            console.error("Errore geolocalizzazione:", error);
            alert("Impossibile ottenere la tua posizione.");
        }

        function startGeolocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(onLocationFound, onLocationError, { enableHighAccuracy: true });
            } else {
                alert("Geolocalizzazione non supportata dal tuo browser.");
            }
        }

        async function addMarkerOnPOI(event) {
            const coords = event.lngLat;
            const poi = await getNearestPOI(coords.lng, coords.lat);

            if (poi) {
                const poiName = poi.name;
                const category = poi.category;
                const iconUrl = getIconForCategory(category);

                const markerEl = document.createElement('div');
                markerEl.style.width = "30px";
                markerEl.style.height = "30px";
                markerEl.style.backgroundSize = "cover";
                markerEl.style.backgroundImage = `url(${iconUrl})`;

                const marker = new maplibregl.Marker({ element: markerEl })
                    .setLngLat([coords.lng, coords.lat])
                    .setPopup(new maplibregl.Popup().setHTML(`<b>${poiName}</b>`))
                    .addTo(map);

                savedMarkers.push({ lat: coords.lat, lon: coords.lng, name: poiName, category });
                localStorage.setItem('markers', JSON.stringify(savedMarkers));

                markerEl.addEventListener('dblclick', () => {
                    marker.remove();
                    savedMarkers = savedMarkers.filter(m => m.lat !== coords.lat && m.lon !== coords.lng);
                    localStorage.setItem('markers', JSON.stringify(savedMarkers));
                });
            } else {
                alert("Nessun punto di interesse trovato qui!");
            }
        }

        async function getNearestPOI(lon, lat) {
            try {
                const response = await fetch(`https://api.maptiler.com/geocoding/${lon},${lat}.json?key=${API_KEY}&types=poi`);
                const data = await response.json();

                if (data.features.length > 0) {
                    const poi = data.features[0];
                    return {
                        name: poi.text || "POI sconosciuto",
                        category: poi.properties?.category || "default"
                    };
                }
                return null;
            } catch (error) {
                console.error("Errore nella richiesta API:", error);
                return null;
            }
        }

        function getIconForCategory(category) {
            const icons = {
                restaurant: 'https://cdn-icons-png.flaticon.com/512/3075/3075977.png',
                bank: 'https://cdn-icons-png.flaticon.com/512/1554/1554567.png',
                shop: 'https://cdn-icons-png.flaticon.com/512/1161/1161388.png',
                default: 'https://cdn-icons-png.flaticon.com/512/684/684908.png'
            };
            return icons[category] || icons['default'];
        }

        function loadSavedMarkers() {
            savedMarkers.forEach(markerData => {
                const markerEl = document.createElement('div');
                markerEl.style.width = "30px";
                markerEl.style.height = "30px";
                markerEl.style.backgroundSize = "cover";
                markerEl.style.backgroundImage = `url(${getIconForCategory(markerData.category)})`;

                const marker = new maplibregl.Marker({ element: markerEl })
                    .setLngLat([markerData.lon, markerData.lat])
                    .setPopup(new maplibregl.Popup().setHTML(`<b>${markerData.name}</b>`))
                    .addTo(map);

                markerEl.addEventListener('dblclick', () => {
                    marker.remove();
                    savedMarkers = savedMarkers.filter(m => m.lat !== markerData.lat && m.lon !== markerData.lon);
                    localStorage.setItem('markers', JSON.stringify(savedMarkers));
                });
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            startGeolocation();
            setTimeout(() => {
                if (map) map.on('click', addMarkerOnPOI);
            }, 2000);
        });
    </script>
</body>
</html>
