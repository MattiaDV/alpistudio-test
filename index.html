<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Geolocalizzazione con Marker</title>
    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        #map { width: 300px; height: 300px; position: relative; }
        #locate-btn { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            z-index: 1000; 
            padding: 10px 20px; 
            background: rgba(0, 0, 0, 0.7); 
            color: white; 
            border: none; 
            cursor: pointer;
            font-size: 16px;
        }
        #locate-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }
    </style>
</head>
<body>
    <button id="locate-btn">Trova la mia posizione</button>
    <div id="map"></div>

    <script>
        const API_KEY = 'e9pLQRlbmlvafLyJ6L8B'; // Sostituisci con la tua API Key di MapTiler
        let map;
        let userMarker = null;
        let firstLoad = true; // Variabile per centrare solo all'inizio

        function onLocationFound(position) {
            console.log("Posizione trovata:", position);
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            // Se Ã¨ il primo caricamento, inizializza la mappa centrata sull'utente
            if (firstLoad) {
                map = new maplibregl.Map({
                    container: 'map',
                    style: `https://api.maptiler.com/maps/streets/style.json?key=${API_KEY}`,
                    center: [lon, lat], 
                    zoom: 15,
                    pitch: 60,
                    bearing: 0,
                    antialias: true
                });

                map.addControl(new maplibregl.NavigationControl());

                // Aggiungi edifici 3D
                map.on('load', () => {
                    map.addLayer({
                        'id': '3d-buildings',
                        'type': 'fill-extrusion',
                        'source': 'openmaptiles',
                        'source-layer': 'building',
                        'minzoom': 14,
                        'paint': {
                            'fill-extrusion-color': '#aaa',
                            'fill-extrusion-height': [
                                'case',
                                ['has', 'height'], ['get', 'height'], 
                                ['has', 'levels'], ['*', ['get', 'levels'], 3], 
                                10 
                            ],
                            'fill-extrusion-base': 0, 
                            'fill-extrusion-opacity': 0.8
                        }
                    });

                    // Crea il marker per la posizione dell'utente
                    userMarker = new maplibregl.Marker({ color: 'red' })
                        .setLngLat([lon, lat])
                        .addTo(map);
                });

                firstLoad = false; // Impedisce ulteriori centraggi automatici
            }

            // Ascolta gli aggiornamenti della posizione SENZA ricentrare la mappa
            navigator.geolocation.watchPosition(updatePosition, onLocationError, { enableHighAccuracy: true });
        }

        function updatePosition(position) {
            console.log("Posizione aggiornata:", position);
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            // Se il marker esiste, aggiorna la posizione SENZA ricentrare la mappa
            if (userMarker) {
                userMarker.setLngLat([lon, lat]);
            }
        }

        function onLocationError(error) {
            console.error("Errore geolocalizzazione:", error);
            alert("Impossibile ottenere la tua posizione.");
        }

        function startGeolocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(onLocationFound, onLocationError, { enableHighAccuracy: true });
            } else {
                alert("Geolocalizzazione non supportata dal tuo browser.");
            }
        }

        document.getElementById("locate-btn").addEventListener("click", startGeolocation);
    </script>
</body>
</html>

