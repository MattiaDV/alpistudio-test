<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mappa Satellite Realistica</title>
  <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    #map {
      width: 300px;
      height: 300px;
      position: relative;
      border: 1px solid black;
      border-radius: 10px;
      margin-top: 20px;
    }
    #mappa {
      width: 300px;
      height: 300px;
      margin-top: 20px;
      border: 1px solid black;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    #toggle-style {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      padding: 5px 10px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .elencoContainer {
        width: 100%;
        position: fixed;
        left: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        color: black;
    }

    .container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0px;
        width: 100%;
        padding: 15px;
        font-family: sans-serif;
        font-size: 16px;
        font-weight: 600;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        background: #aa182c;
        color: white;
    }

    #map {
        display: none;
    }

    #toggle-style {
        display: none;
    }
  </style>
</head>
<body>
  <!-- <div id="map"></div> -->
  <!-- <button id="toggle-style">Satellite</button> -->
    <div class = "elencoContainer" id = "newPage">
        <div class = "container">
            <div class = "logo"><svg width = "30px" height = "30px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g id="System / Data"> <path id="Vector" d="M18 12V17C18 18.6569 15.3137 20 12 20C8.68629 20 6 18.6569 6 17V12M18 12V7M18 12C18 13.6569 15.3137 15 12 15C8.68629 15 6 13.6569 6 12M18 7C18 5.34315 15.3137 4 12 4C8.68629 4 6 5.34315 6 7M18 7C18 8.65685 15.3137 10 12 10C8.68629 10 6 8.65685 6 7M6 12V7" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g> </g></svg></div>
            <div class = "text">Elenco</div>
        </div>
    </div>
  <script>
    /* const API_KEY = 'e9pLQRlbmlvafLyJ6L8B'; // Sostituisci con la tua API Key di MapTiler
    let map;
    let userMarker = null;
    let firstLoad = true;
    let savedMarkers = JSON.parse(localStorage.getItem('markers')) || [];
    let currentStyle = 'streets'; // "streets" o "satellite"

    // Funzione per calcolare la distanza (formula di Haversine)
    function computeDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const φ1 = lat1 * Math.PI / 180;
      const φ2 = lat2 * Math.PI / 180;
      const Δφ = (lat2 - lat1) * Math.PI / 180;
      const Δλ = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(Δφ / 2) ** 2 +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function onLocationFound(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      if (firstLoad) {
        map = new maplibregl.Map({
          container: 'map',
          style: `https://api.maptiler.com/maps/streets/style.json?key=${API_KEY}`,
          center: [lon, lat],
          zoom: 15,
          pitch: 60,
          bearing: 0,
          antialias: true
        });

        map.addControl(new maplibregl.NavigationControl());

        // Gestione immagini mancanti (sprite)
        map.on('styleimagemissing', function(e) {
          if (e.id === 'office_11' || e.id === 'atm_11') {
            const canvas = document.createElement('canvas');
            canvas.width = 30;
            canvas.height = 30;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'gray';
            ctx.fillRect(0, 0, 30, 30);
            map.addImage(e.id, canvas);
          }
        });

        // Marker per la posizione utente
        userMarker = new maplibregl.Marker({ color: 'red' })
          .setLngLat([lon, lat])
          .addTo(map);

        map.on('load', () => {
          loadSavedMarkers();
          // Se siamo in modalità satellite, aggiungiamo il DEM e attiviamo il terreno
          if (currentStyle === 'satellite') {
            addTerrain();
          }
          // Aggiungiamo una luce per migliorare l'effetto 3D
          map.setLight({ anchor: 'viewport', color: 'white', intensity: 0.5 });
        });

        firstLoad = false;
      }
      navigator.geolocation.watchPosition(updatePosition, onLocationError, { enableHighAccuracy: true });
    }

    function updatePosition(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      if (userMarker) {
        userMarker.setLngLat([lon, lat]);
      }
    }

    function onLocationError(error) {
      console.error("Errore geolocalizzazione:", error);
      alert("Impossibile ottenere la tua posizione.");
    }

    function startGeolocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(onLocationFound, onLocationError, { enableHighAccuracy: true });
      } else {
        alert("Geolocalizzazione non supportata dal tuo browser.");
      }
    }

    function loadSavedMarkers() {
      savedMarkers.forEach(markerData => {
        const markerEl = document.createElement('div');
        markerEl.style.width = "30px";
        markerEl.style.height = "30px";
        markerEl.style.backgroundSize = "cover";
        markerEl.style.backgroundImage = `url(${getIconForCategory(markerData.category)})`;
        markerEl.style.cursor = "pointer";
        const marker = new maplibregl.Marker({ element: markerEl })
          .setLngLat([markerData.lon, markerData.lat])
          .setPopup(new maplibregl.Popup({ offset: 25 }).setHTML(`<b>${markerData.name}</b>`))
          .addTo(map);
        marker.getElement().style.pointerEvents = 'auto';
        marker.getElement().addEventListener('contextmenu', (e) => {
          e.preventDefault();
          e.stopPropagation();
          marker.remove();
          savedMarkers = savedMarkers.filter(m => computeDistance(m.lat, m.lon, markerData.lat, markerData.lon) >= 10);
          localStorage.setItem('markers', JSON.stringify(savedMarkers));
        });
      });
    }

    // Funzione per aggiungere un source DEM e abilitare il terrain
    function addTerrain() {
      if (!map.getSource('maptiler-dem')) {
        map.addSource('maptiler-dem', {
          type: 'raster-dem',
          url: `https://api.maptiler.com/tiles/terrain/{z}/{x}/{y}.png?key=${API_KEY}`,
          tileSize: 256,
          maxzoom: 14
        });
      }
      map.setTerrain({ source: 'maptiler-dem', exaggeration: 1.2 });
    }

    // Funzione per rimuovere il terreno (opzionale, se torni a streets)
    function removeTerrain() {
      map.setTerrain(null);
      if (map.getSource('maptiler-dem')) {
        map.removeSource('maptiler-dem');
      }
    }

    // Funzioni per ottenere POI e icone (rimangono invariate rispetto alla versione precedente)
    async function getNearestPOI(lon, lat) {
      try {
        const response = await fetch(`https://api.maptiler.com/geocoding/${lon},${lat}.json?key=${API_KEY}&types=poi`);
        const data = await response.json();
        if (data.features.length > 0) {
          const poi = data.features[0];
          const poiCoords = poi.geometry.coordinates;
          const distance = computeDistance(lat, lon, poiCoords[1], poiCoords[0]);
          if (distance <= 50) {  // soglia di 50 metri
            let poiCategory = "";
            if (poi.properties && poi.properties.category) {
              poiCategory = poi.properties.category.toLowerCase();
            }
            if (!poiCategory && poi.text) {
              poiCategory = poi.text.toLowerCase();
            }
            // Parole chiave ammesse per il cibo/ristorazione (inglese e italiano)
            const allowedKeywords = ["restaurant", "ristorante", "fast food", "bar", "cafe", "caffè", "pub", "autogrill", "tavola calda", "trattoria", "osteria", "pizzeria"];
            const isAllowed = allowedKeywords.some(keyword => poiCategory.includes(keyword));
            if (!isAllowed) {
              console.log("POI non alimentare:", poiCategory);
              return null;
            }
            return {
              name: poi.text || "POI sconosciuto",
              category: (poi.properties?.category || "default").toLowerCase(),
              poiLon: poiCoords[0],
              poiLat: poiCoords[1]
            };
          }
        }
        return null;
      } catch (error) {
        console.error("Errore nella richiesta API:", error);
        return null;
      }
    }

    function getIconForCategory(category) {
      const icons = {
        restaurant: 'https://cdn-icons-png.flaticon.com/512/3075/3075977.png',
        ristorante: 'https://cdn-icons-png.flaticon.com/512/3075/3075977.png',
        fast_food: 'https://cdn-icons-png.flaticon.com/512/3075/3075977.png',
        bar: 'https://cdn-icons-png.flaticon.com/512/1554/1554567.png',
        cafe: 'https://cdn-icons-png.flaticon.com/512/1161/1161388.png',
        "caffè": 'https://cdn-icons-png.flaticon.com/512/1161/1161388.png',
        pub: 'https://cdn-icons-png.flaticon.com/512/1161/1161388.png',
        autogrill: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
        "tavola calda": 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
        trattoria: 'https://cdn-icons-png.flaticon.com/512/3075/3075977.png',
        osteria: 'https://cdn-icons-png.flaticon.com/512/3075/3075977.png',
        pizzeria: 'https://cdn-icons-png.flaticon.com/512/3075/3075977.png',
        default: 'https://cdn-icons-png.flaticon.com/512/684/684908.png'
      };
      return icons[category.toLowerCase()] || icons['default'];
    }

    // Aggiunge un marker con tasto destro solo se il click è vicino a un POI alimentare e non esiste già un marker entro 10 metri
    async function addMarkerOnPOI(event) {
      event.preventDefault();
      const coords = event.lngLat;
      const duplicate = savedMarkers.some(m => computeDistance(m.lat, m.lon, coords.lat, coords.lng) < 10);
      if (duplicate) {
        alert("Esiste già un marker in questa posizione!");
        return;
      }
      const poi = await getNearestPOI(coords.lng, coords.lat);
      if (poi) {
        const poiName = poi.name;
        const category = poi.category;
        const iconUrl = getIconForCategory(category);
        const markerEl = document.createElement('div');
        markerEl.style.width = "30px";
        markerEl.style.height = "30px";
        markerEl.style.backgroundSize = "cover";
        markerEl.style.backgroundImage = `url(${iconUrl})`;
        markerEl.style.cursor = "pointer";
        const marker = new maplibregl.Marker({ element: markerEl })
          .setLngLat([coords.lng, coords.lat])
          .setPopup(new maplibregl.Popup({ offset: 25 }).setHTML(`<b>${poiName}</b>`))
          .addTo(map);
        savedMarkers.push({ lat: coords.lat, lon: coords.lng, name: poiName, category });
        localStorage.setItem('markers', JSON.stringify(savedMarkers));
        marker.getElement().style.pointerEvents = 'auto';
        marker.getElement().addEventListener('contextmenu', (e) => {
          e.preventDefault();
          e.stopPropagation();
          marker.remove();
          savedMarkers = savedMarkers.filter(m => computeDistance(m.lat, m.lon, coords.lat, coords.lng) >= 10);
          localStorage.setItem('markers', JSON.stringify(savedMarkers));
        });
      } else {
        alert("Nessun POI alimentare valido trovato qui. Clicca più vicino a un punto d'interesse legato al cibo!");
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      startGeolocation();
      // Usa "contextmenu" per inserire marker con il tasto destro
      setTimeout(() => {
        if (map) map.on('contextmenu', addMarkerOnPOI);
      }, 2000);
    });

    // Gestione del pulsante per il cambio di stile
    document.getElementById('toggle-style').addEventListener('click', () => {
      if (!map) return;
      if (currentStyle === 'streets') {
        map.setStyle(`https://api.maptiler.com/maps/satellite/style.json?key=${API_KEY}`);
        currentStyle = 'satellite';
        document.getElementById('toggle-style').textContent = 'Streets';
        map.once('styledata', () => {
          // Aggiungiamo il DEM e attiviamo il terreno nella modalità satellite
          addTerrain();
          map.setLight({ anchor: 'viewport', color: 'white', intensity: 0.7 });
          loadSavedMarkers();
        });
      } else {
        map.setStyle(`https://api.maptiler.com/maps/streets/style.json?key=${API_KEY}`);
        currentStyle = 'streets';
        document.getElementById('toggle-style').textContent = 'Satellite';
        map.once('styledata', () => {
          removeTerrain();
          map.setLight({ anchor: 'viewport', color: 'white', intensity: 0.5 });
          loadSavedMarkers();
        });
      }
    }); */

    let newPage = document.getElementById('newPage');
    newPage.addEventListener('click', function() {
        window.location.href = "https://www.google.it/maps/place/40%C2%B019'38.5%22N+9%C2%B020'03.5%22E/@40.327353,9.3317351,17z/data=!3m1!4b1!4m4!3m3!8m2!3d40.327353!4d9.33431?entry=ttu&g_ep=EgoyMDI1MDIyNC4wIKXMDSoASAFQAw%3D%3D";
    })
  </script>
  
  
 <iframe width="100%" height="100%" frameborder="0" allowfullscreen allow="geolocation" 
    src="//umap.openstreetmap.fr/it/map/mappa_1181759?scaleControl=false&miniMap=false&scrollWheelZoom=false&zoomControl=true&editMode=disabled&moreControl=true&searchControl=null&tilelayersControl=null&embedControl=null&datalayersControl=true&onLoadPanel=none&captionBar=false&captionMenus=true&darkMode=true"></iframe>
<p><a href="//umap.openstreetmap.fr/it/map/mappa_1181759?scaleControl=false&miniMap=false&scrollWheelZoom=true&zoomControl=true&editMode=disabled&moreControl=true&searchControl=null&tilelayersControl=null&embedControl=null&datalayersControl=true&onLoadPanel=none&captionBar=false&captionMenus=true&darkMode=true">Visualizza a schermo intero</a></p>


</body>
</html>
