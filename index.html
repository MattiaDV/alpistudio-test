<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Geolocalizzazione con Marker</title>
    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; }
        #map { width: 100%; height: 100vh; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        const API_KEY = 'e9pLQRlbmlvafLyJ6L8B'; // Sostituisci con la tua API Key di MapTiler
        let map;
        let userMarker = null;

        // Funzione per ottenere la posizione geolocalizzata
        function onLocationFound(position) {
            console.log("Posizione trovata:", position);  // Log della posizione trovata
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            map = new maplibregl.Map({
                container: 'map',
                style: `https://api.maptiler.com/maps/streets/style.json?key=${API_KEY}`,
                center: [lon, lat], // Imposta la posizione iniziale sulla posizione dell'utente
                zoom: 15,
                pitch: 60,
                bearing: 0,
                antialias: true
            });

            map.addControl(new maplibregl.NavigationControl());

            // Aggiungi edifici 3D con altezze realistiche
            map.on('load', () => {
                map.addLayer({
                    'id': '3d-buildings',
                    'type': 'fill-extrusion',
                    'source': 'openmaptiles',
                    'source-layer': 'building',
                    'minzoom': 14,
                    'paint': {
                        'fill-extrusion-color': '#aaa', // Colore degli edifici
                        'fill-extrusion-height': [
                            'case',
                            ['has', 'height'], ['get', 'height'], // Usa altezza reale se disponibile
                            ['has', 'levels'], ['*', ['get', 'levels'], 3], // Se non c'Ã¨, moltiplica i piani x3m
                            10 // Se mancano entrambi, assegna altezza minima di 10m
                        ],
                        'fill-extrusion-base': 0, 
                        'fill-extrusion-opacity': 0.8
                    }
                });

                // Crea il marker per la posizione dell'utente
                userMarker = new maplibregl.Marker({ color: 'red' })
                    .setLngLat([lon, lat])  // Posiziona il marker inizialmente
                    .addTo(map);
            });

            // Funzione per aggiornare la posizione in tempo reale
            function updatePosition(position) {
                console.log("Posizione aggiornata:", position);  // Log della posizione aggiornata
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                // Se il marker esiste, aggiorna la sua posizione
                if (userMarker) {
                    userMarker.setLngLat([lon, lat]);  // Aggiorna la posizione del marker
                }

                // Centra la mappa sulla nuova posizione
                map.setCenter([lon, lat]);
            }

            // Ascolta gli aggiornamenti della posizione
            navigator.geolocation.watchPosition(updatePosition, onLocationError, { enableHighAccuracy: true });
        }

        // Funzione per gestire il caso in cui la geolocalizzazione non sia disponibile
        function onLocationError(error) {
            console.error("Errore geolocalizzazione:", error); // Log dell'errore
            alert("Impossibile ottenere la tua posizione.");
        }

        // Chiamata alla geolocalizzazione
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(onLocationFound, onLocationError, { enableHighAccuracy: true });
        } else {
            alert("Geolocalizzazione non supportata dal tuo browser.");
        }
    </script>
</body>
</html>
