<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mappa con POI Alimentari</title>
  <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #map {
      width: 300px;
      height: 300px;
      position: relative;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    const API_KEY = 'e9pLQRlbmlvafLyJ6L8B'; // Sostituisci con la tua API Key di MapTiler
    let map;
    let userMarker = null;
    let firstLoad = true;
    let savedMarkers = JSON.parse(localStorage.getItem('markers')) || [];

    // Formula di Haversine per calcolare la distanza in metri
    function computeDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000; // raggio della Terra in metri
      const φ1 = lat1 * Math.PI / 180;
      const φ2 = lat2 * Math.PI / 180;
      const Δφ = (lat2 - lat1) * Math.PI / 180;
      const Δλ = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(Δφ / 2) ** 2 +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function onLocationFound(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      if (firstLoad) {
        map = new maplibregl.Map({
          container: 'map',
          style: `https://api.maptiler.com/maps/streets/style.json?key=${API_KEY}`,
          center: [lon, lat],
          zoom: 15,
          pitch: 60,
          bearing: 0,
          antialias: true
        });
        map.addControl(new maplibregl.NavigationControl());
        // Gestione immagini mancanti per alcuni sprite
        map.on('styleimagemissing', function(e) {
          if (e.id === 'office_11' || e.id === 'atm_11') {
            const canvas = document.createElement('canvas');
            canvas.width = 30;
            canvas.height = 30;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'gray';
            ctx.fillRect(0, 0, 30, 30);
            map.addImage(e.id, canvas);
          }
        });
        // Marker per la posizione utente
        userMarker = new maplibregl.Marker({ color: 'red' })
          .setLngLat([lon, lat])
          .addTo(map);
        map.on('load', () => {
          loadSavedMarkers();
        });
        firstLoad = false;
      }
      navigator.geolocation.watchPosition(updatePosition, onLocationError, { enableHighAccuracy: true });
    }

    function updatePosition(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      if (userMarker) {
        userMarker.setLngLat([lon, lat]);
      }
    }

    function onLocationError(error) {
      console.error("Errore geolocalizzazione:", error);
      alert("Impossibile ottenere la tua posizione.");
    }

    function startGeolocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(onLocationFound, onLocationError, { enableHighAccuracy: true });
      } else {
        alert("Geolocalizzazione non supportata dal tuo browser.");
      }
    }

    // Funzione che restituisce il POI più vicino (entro 50 metri) solo se legato al cibo/ristorazione
    async function getNearestPOI(lon, lat) {
      try {
        const response = await fetch(`https://api.maptiler.com/geocoding/${lon},${lat}.json?key=${API_KEY}&types=poi`);
        const data = await response.json();
        if (data.features.length > 0) {
          const poi = data.features[0];
          const poiCoords = poi.geometry.coordinates; // [lon, lat]
          const distance = computeDistance(lat, lon, poiCoords[1], poiCoords[0]);
          if (distance <= 50) {  // soglia di 50 metri
            // Otteniamo la categoria, provando sia la proprietà che il testo
            let poiCategory = "";
            if (poi.properties && poi.properties.category) {
              poiCategory = poi.properties.category.toLowerCase();
            } else if (poi.text) {
              poiCategory = poi.text.toLowerCase();
            }
            // Lista di parole chiave consentite
            const allowedKeywords = ["restaurant", "fast food", "bar", "cafe", "pub", "autogrill", "tavola calda", "trattoria", "osteria", "pizzeria"];
            const isAllowed = allowedKeywords.some(keyword => poiCategory.includes(keyword));
            if (!isAllowed) {
              return null;
            }
            return {
              name: poi.text || "POI sconosciuto",
              category: (poi.properties?.category || "default").toLowerCase(),
              poiLon: poiCoords[0],
              poiLat: poiCoords[1]
            };
          }
        }
        return null;
      } catch (error) {
        console.error("Errore nella richiesta API:", error);
        return null;
      }
    }

    function getIconForCategory(category) {
      const icons = {
        restaurant: 'https://cdn-icons-png.flaticon.com/512/3075/3075977.png',
        fast_food: 'https://cdn-icons-png.flaticon.com/512/3075/3075977.png',
        bar: 'https://cdn-icons-png.flaticon.com/512/1554/1554567.png',
        cafe: 'https://cdn-icons-png.flaticon.com/512/1161/1161388.png',
        pub: 'https://cdn-icons-png.flaticon.com/512/1161/1161388.png',
        autogrill: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
        "tavola calda": 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
        trattoria: 'https://cdn-icons-png.flaticon.com/512/3075/3075977.png',
        osteria: 'https://cdn-icons-png.flaticon.com/512/3075/3075977.png',
        pizzeria: 'https://cdn-icons-png.flaticon.com/512/3075/3075977.png',
        default: 'https://cdn-icons-png.flaticon.com/512/684/684908.png'
      };
      return icons[category.toLowerCase()] || icons['default'];
    }

    // Aggiunge un marker solo se il click (tasto destro) è vicino a un POI alimentare valido e non esiste già un marker entro 10 metri
    async function addMarkerOnPOI(event) {
      event.preventDefault(); // Impedisce il menu contestuale
      const coords = event.lngLat;
      // Controlla duplicati (entro 10 metri)
      const duplicate = savedMarkers.some(m => computeDistance(m.lat, m.lon, coords.lat, coords.lng) < 10);
      if (duplicate) {
        alert("Esiste già un marker in questa posizione!");
        return;
      }
      const poi = await getNearestPOI(coords.lng, coords.lat);
      if (poi) {
        const poiName = poi.name;
        const category = poi.category;
        const iconUrl = getIconForCategory(category);
        const markerEl = document.createElement('div');
        markerEl.style.width = "30px";
        markerEl.style.height = "30px";
        markerEl.style.backgroundSize = "cover";
        markerEl.style.backgroundImage = `url(${iconUrl})`;
        markerEl.style.cursor = "pointer";
        const marker = new maplibregl.Marker({ element: markerEl })
          .setLngLat([coords.lng, coords.lat])
          .setPopup(new maplibregl.Popup({ offset: 25 }).setHTML(`<b>${poiName}</b>`))
          .addTo(map);
        savedMarkers.push({ lat: coords.lat, lon: coords.lng, name: poiName, category });
        localStorage.setItem('markers', JSON.stringify(savedMarkers));
        // Rimuovi il marker con il tasto destro sul marker stesso
        marker.getElement().style.pointerEvents = 'auto';
        marker.getElement().addEventListener('contextmenu', (e) => {
          e.preventDefault();
          e.stopPropagation();
          marker.remove();
          savedMarkers = savedMarkers.filter(m => computeDistance(m.lat, m.lon, coords.lat, coords.lng) >= 10);
          localStorage.setItem('markers', JSON.stringify(savedMarkers));
        });
      } else {
        alert("Nessun POI alimentare valido trovato qui. Clicca più vicino a un punto d'interesse legato al cibo!");
      }
    }

    function loadSavedMarkers() {
      savedMarkers.forEach(markerData => {
        const markerEl = document.createElement('div');
        markerEl.style.width = "30px";
        markerEl.style.height = "30px";
        markerEl.style.backgroundSize = "cover";
        markerEl.style.backgroundImage = `url(${getIconForCategory(markerData.category)})`;
        markerEl.style.cursor = "pointer";
        const marker = new maplibregl.Marker({ element: markerEl })
          .setLngLat([markerData.lon, markerData.lat])
          .setPopup(new maplibregl.Popup({ offset: 25 }).setHTML(`<b>${markerData.name}</b>`))
          .addTo(map);
        marker.getElement().style.pointerEvents = 'auto';
        marker.getElement().addEventListener('contextmenu', (e) => {
          e.preventDefault();
          e.stopPropagation();
          marker.remove();
          savedMarkers = savedMarkers.filter(m => computeDistance(m.lat, m.lon, markerData.lat, markerData.lon) >= 10);
          localStorage.setItem('markers', JSON.stringify(savedMarkers));
        });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      startGeolocation();
      setTimeout(() => {
        if (map) map.on('contextmenu', addMarkerOnPOI);
      }, 2000);
    });
  </script>
</body>
</html>
